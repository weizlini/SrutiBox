var sruti={samples:["01_c1.wav","02_c1-sharp.wav","03_d1.wav","04_d1-sharp.wav","05_e1.wav","06_f1.wav","07_f1-sharp.wav","08_g1.wav","09_g1-sh.wav","10_a1.wav","11_a1-sharp.wav","12_b1.wav","13_c2.wav"],baseUrl:"",AudioContext:null,source:[],init:function(a){a?this.baseUrl=a:this.baseUrl="",window.AudioContext=window.AudioContext||window.webkitAudioContext,this.AudioContext=new window.AudioContext,this.gainNode=this.AudioContext.createGain(),this.gainNode.connect(this.AudioContext.destination),this.loadSamples()},notesPlaying:[],clearNotes:function(){var a=this;$.each(this.notesPlaying,function(b,c){a.log("the label"),a.log(c),a.playing&&(c.source.stop(),c.source=null)}),this.notesPlaying=[]},removeNote:function(a){var b,c=this;$.each(this.notesPlaying,function(d,e){c.log(e),c.log(d),e==a&&(c.log("found"),c.playing&&(e.source.stop(),e.source=null),b=d)}),(b||0===b)&&c.notesPlaying.splice(b,1),c.log("splice-index:"+b),c.log(this.notesPlaying)},addNote:function(a){$.each(this.notesPlaying,function(a,b){}),this.playing&&(a.source=sruti.AudioContext.createBufferSource(),a.source.buffer=sruti.source[$(a).data("id")-1].buffer,a.source.connect(this.gainNode),a.source.loop=!0,a.source.start()),this.notesPlaying.push(a),this.log(this.notesPlaying)},initUI:function(){var _this=this;$(".sruti-box").show(),$(".loading").hide(),$(window).on("resize",function(){$(".sruti_keyboard").width($(".sruti-box").width()>240?240:$(".sruti-box").width())}),$(window).trigger("resize"),$(".sruti-box label").click(function(a){a.stopPropagation(),$(this).hasClass("on")?(sruti.removeNote(this),$(this).removeClass("on")):(sruti.addNote(this),$(this).addClass("on"))}),$(".start").click(function(){$(this).hasClass("on")?(sruti.stop(),$(".start").removeClass("on"),$(this).html("play")):(sruti.playing||sruti.play(),$(this).addClass("on"),$(this).html("stop"))}),$("#drone-picker").on("change",function(){var value=$(this).val(),wasplaying=_this.playing;_this.stop(),_this.clearNotes(),$(".sruti-box label").removeClass("on");var noteIds=eval($("#drone-picker option[value="+value+"]").data("notes"));$(noteIds).each(function(a,b){label=$("#"+b),_this.log(label),label.trigger("click")}),setTimeout(function(){wasplaying&&_this.play()},0)}),$("#drone-picker").trigger("change")},debug:!0,log:function(a){this.debug&&(console.log("-----------------------------------"),console.dir(a),console.trace())},_loadedSamples:0,loadSample:function(a,b){sruti.log("about to load "+a);var c=new XMLHttpRequest;c.open("GET",this.baseUrl+"audio/"+a,!0),c.responseType="arraybuffer",c.onload=function(){sruti.log(a+" loaded"),sruti.AudioContext.decodeAudioData(c.response,function(a){b.buffer=a,b.connect(sruti.AudioContext.destination),b.loop=!0,sruti._loadedSamples++,sruti._loadedSamples==sruti.samples.length&&sruti._onSamplesLoad()})},c.onerror=function(a){console.error(c.statusText)},c.send(),sruti.log("request sent")},loadSamples:function(){sruti.samples.length;this.samples.forEach(function(a,b){sruti.log("loading "+a),sruti.source[b]=sruti.AudioContext.createBufferSource(),sruti.loadSample(a,sruti.source[b])})},_onSamplesLoad:function(){this.initUI()},tempo:54,loopTimeout:null,playing:!1,activeSources:[],play:function(){if(this.log("play called"),!this.playing){var a=this;this.log(this.notesPlaying),this.gainNode.gain.value=0,$.each(this.notesPlaying,function(b,c){a.log("label:"),a.log(c),a.log("index"),a.log(b),c.source&&(c.source.stop(),c.source=null),c.source=sruti.AudioContext.createBufferSource(),c.source.buffer=sruti.source[$(c).data("id")-1].buffer,c.source.connect(sruti.gainNode),c.source.loop=!0,c.source.start()});var b=0,c=function(){b>=1?(a.gainNode.gain.value=1,a.playing=!0):(b+=.05,a.gainNode.gain.value=b,setTimeout(c,50))};setTimeout(c,0)}},stop:function(){$.each(this.notesPlaying,function(a,b){b.source&&(b.source.stop(),b.source=null)}),this.playing=!1}};